#!/usr/bin/env bash

set -e
# Save some useful information
REPO=`git config remote.origin.url`
SSH_REPO=${REPO/https:\/\/github.com\//git@github.com:}
SHA=`git rev-parse --verify HEAD`
git remote add github $SSH_REPO
git fetch github

function setMaster() {
  git checkout github/master || throwError "Unable to checkout master."
}
function setStage() {
  git checkout github/stage || throwError "Unable to checkout stage."
}
function version() {
  local __version=$1
  local version=`node -pe 'JSON.parse(process.argv[1]).version' "$(cat bower.json)"`
  eval $__version="'$version'"
}
function throwError() {
  echo $1
  exit 111
}
function processStage() {
  # First read version number from the master branch.
  setMaster
  version elementVersion || throwError "Error to read element version number."
  setStage
  echo "Bumping version"
  ./node_modules/.bin/arc bump $elementVersion || throwError "Unable to bump version"
  echo "Generating docs"
  ./node_modules/.bin/arc docs || throwError "Unable to generate docs"
  echo "Building changelog"
  ./node_modules/.bin/arc changelog || throwError "Unable to build changelog"
  git add -A
  echo "Commiting changes made to the stage branch"
  git commit -m "[CI] Automated commit after stage build (bump, docs, changelog)." || throwError "Unable to commit changes to stage. Exiting."

  echo "Stage updated, merging with master"
  setMaster
  git merge --no-ff -m "[CI] Automated merge stage->master" github/stage || throwError "Unable to merge changes to master. Exiting."
  git add -A
  git commit -m "[CI] Automated commit after merge stage->master"
  git push github master || throwError "Unable to push changes to master. Exiting."
  setStage
  git push github stage || {
    echo "Changes to master has been made, however error occurred when pushing changes to the stage. Please, merge stage manually from master."
    exit 0;
  }
}


if [[ "${TRAVIS_PULL_REQUEST}" == "false" ]] && [[ "${TRAVIS_BRANCH}" == "stage" ]]; then
  echo "Updating stage branch and merging with master..."
  processStage
  exit
fi

if [[ "${TRAVIS_PULL_REQUEST}" == "false" ]] && [[ "${TRAVIS_BRANCH}" == "master" ]]; then
  echo "Deploying release to master branch..."
  exit
fi

echo "Nothing to do. Is RP: ${TRAVIS_PULL_REQUEST}, on branch ${TRAVIS_BRANCH}"
exit
